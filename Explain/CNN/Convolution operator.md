# üß† T·ªïng qu√°t h√≥a ‚Äì Convolutional Neural Network (CNN)

![CNN](../../imgs/cnn.jpg)

- M·∫°ng n∆°ron th·∫ßn kinh t√≠ch ch·∫≠p s·ª≠ d·ª•ng to√°n t·ª≠ convolution ƒë·ªÉ tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng h√¨nh ·∫£nh.

`Image + Filters = Feature Maps`

- C·∫•u tr√∫c CNN g·ªìm c√°c th√†nh ph·∫ßn ch√≠nh:

1. Feature maps: thu ƒë∆∞·ª£c th√¥ng qua c√°c l·ªõp convolution.

2. Pooling: g·ªôp/t·ªïng h·ª£p ƒë·∫∑c tr∆∞ng ƒë·ªÉ gi·∫£m k√≠ch th∆∞·ªõc v√† tƒÉng t√≠nh kh√°i qu√°t.

3. Normalization: chu·∫©n h√≥a d·ªØ li·ªáu ƒë·ªÉ tƒÉng hi·ªáu qu·∫£ hu·∫•n luy·ªán.

4. Ph√¢n lo·∫°i: th·ª±c hi·ªán qua c√°c l·ªõp Fully Connected (FC).

---
---

# Convolution (Cross-correlation) v√† C√°c Kernel Ph·ªï Bi·∫øn trong Computer Vision

Trong YOLO v√† h·∫ßu h·∫øt c√°c CNN, "convolution" th·ª±c ch·∫•t l√† **cross-correlation**:

$$
S(x, y) = \sum_m \sum_n I(x+m, y+n) \cdot K(m, n)
$$

- $I$: ·∫£nh ƒë·∫ßu v√†o  
- $K$: kernel (m·∫∑t n·∫° l·ªçc, th∆∞·ªùng c√≥ k√≠ch th∆∞·ªõc 3x3 ho·∫∑c 5x5)  
- $S$: ·∫£nh ƒë·∫ßu ra  

---

## 1. M·ªôt s·ªë kernel ph·ªï bi·∫øn

### a) Laplacian (l·ªçc bi√™n to√†n c·ª•c)

$$
K = \begin{bmatrix}
0 & -1 & 0 \\
-1 & 4 & -1 \\
0 & -1 & 0
\end{bmatrix}
$$

---

### b) Horizontal Filter (bi√™n ngang)

$$
K = \begin{bmatrix}
-1 & -1 & -1 \\
2 & 2 & 2 \\
-1 & -1 & -1
\end{bmatrix}
$$

---

### c) Blur (l√†m m·ªù trung b√¨nh)

$$
K = \frac{1}{9} \begin{bmatrix}
1 & 1 & 1 \\
1 & 1 & 1 \\
1 & 1 & 1
\end{bmatrix}
$$

---

## 2. V√≠ d·ª• minh h·ªça: Ma tr·∫≠n 5x5 l·ªçc v·ªõi kernel 3x3

Gi·∫£ s·ª≠ ·∫£nh ƒë·∫ßu v√†o:

$$
I = \begin{bmatrix}
1 & 2 & 3 & 4 & 5 \\
5 & 6 & 7 & 8 & 9 \\
9 & 8 & 7 & 6 & 5 \\
4 & 3 & 2 & 1 & 0 \\
0 & 1 & 2 & 3 & 4
\end{bmatrix}
$$

Ch·ªçn v·ªã tr√≠ **pixel trung t√¢m $(x=2, y=2)$**, t·ª©c h√†ng 3, c·ªôt 3 (theo ch·ªâ s·ªë 1-based).  
V√πng l√¢n c·∫≠n 3x3 quanh ƒëi·ªÉm n√†y l√†:

$$
I_{local} = \begin{bmatrix}
6 & 7 & 8 \\
8 & 7 & 6 \\
3 & 2 & 1
\end{bmatrix}
$$

---

![Horizontal](../../imgs/Horizontal.jpg)

### a) Horizontal Filter (bi√™n ngang)

Kernel:

$$
K = \begin{bmatrix}
-1 & -1 & -1 \\
2 & 2 & 2 \\
-1 & -1 & -1
\end{bmatrix}
$$

T√≠nh:

$$
S_{edge}(2,2) = (6)(-1)+(7)(-1)+(8)(-1) \\
+ (8)(2)+(7)(2)+(6)(2) \\
+ (3)(-1)+(2)(-1)+(1)(-1)
$$

K·∫øt qu·∫£:

$$
S_{edge}(2,2) = 15
$$

> **√ù nghƒ©a**: Gi√° tr·ªã d∆∞∆°ng l·ªõn cho th·∫•y c√≥ ƒë∆∞·ªùng bi√™n ngang m·∫°nh t·∫°i v√πng n√†y.

---

![Laplacian](../../imgs/Laplacian.jpg)

### b) Laplacian (l·ªçc bi√™n to√†n c·ª•c)

Kernel:

$$
K = \begin{bmatrix}
0 & -1 & 0 \\
-1 & 4 & -1 \\
0 & -1 & 0
\end{bmatrix}
$$

T√≠nh:

$$
S_{lap}(2,2) = (7)(-1) + (8)(-1) + (8)(-1) + (6)(-1) + (7)(4)
$$

K·∫øt qu·∫£:

$$
S_{lap}(2,2) = -7 -8 -8 -6 + 28 = -1
$$

> **√ù nghƒ©a**: K·∫øt qu·∫£ g·∫ßn 0 ‚Üí t·∫°i v·ªã tr√≠ n√†y kh√¥ng c√≥ bi√™n r√µ r·ªát theo Laplacian.

---

![Blur](../../imgs/Blur.jpg)

### c) Blur (l√†m m·ªù trung b√¨nh)

Kernel:

$$
K = \frac{1}{9} \begin{bmatrix}
1 & 1 & 1 \\
1 & 1 & 1 \\
1 & 1 & 1
\end{bmatrix}
$$

T√≠nh trung b√¨nh 9 gi√° tr·ªã trong $I_{local}$:

$$
S_{blur}(2,2) = \frac{6+7+8+8+7+6+3+2+1}{9}
$$

K·∫øt qu·∫£:

$$
S_{blur}(2,2) = \frac{48}{9} \approx 5.33
$$

> **√ù nghƒ©a**: L√†m m·ªù ‚Üí gi√° tr·ªã pixel tr·ªü th√†nh trung b√¨nh, gi√∫p gi·∫£m nhi·ªÖu.

---

## 3. Nh·∫≠n x√©t

- **Edge Filter (custom)**: nh·∫•n m·∫°nh c·∫°nh ngang, k·∫øt qu·∫£ l·ªõn (15).  
- **Laplacian**: b·∫Øt bi√™n ƒëa h∆∞·ªõng, t·∫°i ƒëi·ªÉm n√†y g·∫ßn nh∆∞ kh√¥ng c√≥ bi√™n r√µ ($-1$).  
- **Blur**: l√†m m·ªù, pixel trung t√¢m th√†nh gi√° tr·ªã trung b√¨nh ($5.33$).

üëâ Ba b·ªô l·ªçc c√πng √°p d·ª•ng tr√™n m·ªôt v√πng, nh∆∞ng k·∫øt qu·∫£ kh√°c nhau ho√†n to√†n ‚Üí cho th·∫•y m·ªói kernel "nh√¨n ·∫£nh" theo m·ªôt c√°ch ri√™ng ƒë·ªÉ tr√≠ch xu·∫•t ƒë·∫∑c tr∆∞ng.

---

## 3. K·∫øt lu·∫≠n

- Convolution (cross-correlation) l√† ph√©p nh√¢n tr∆∞·ª£t kernel tr√™n ·∫£nh.  
- C√°c kernel ph·ªï bi·∫øn:  
  - **Laplacian** ‚Üí nh·∫•n m·∫°nh bi√™n to√†n c·ª•c  
  - **Edge Filter (custom)** ‚Üí ph√°t hi·ªán bi√™n ngang r√µ r·ªát  
  - **Blur** ‚Üí l√†m m·ªù, gi·∫£m nhi·ªÖu  
- V√≠ d·ª• v·ªõi ma tr·∫≠n 5x5 cho th·∫•y c√°ch t√≠nh c·ª• th·ªÉ t·ª´ng gi√° tr·ªã pixel sau khi l·ªçc.

---

## 4. Pipeline: ·∫¢nh g·ªëc ‚Üí Blur ‚Üí Edge Filter

Trong th·ª±c t·∫ø, ƒë·ªÉ **ph√°t hi·ªán bi√™n** t·ªët h∆°n, ta kh√¥ng √°p d·ª•ng tr·ª±c ti·∫øp Sobel hay Laplacian l√™n ·∫£nh g·ªëc, m√† th∆∞·ªùng th√™m b∆∞·ªõc **l√†m m·ªù (Blur)** tr∆∞·ªõc.  

### L√Ω do:
- ·∫¢nh g·ªëc th∆∞·ªùng c√≥ **nhi·ªÖu (noise)**: pixel ƒë∆°n l·∫ª s√°ng/t·ªëi b·∫•t th∆∞·ªùng.  
- N·∫øu √°p ngay edge filter ‚Üí nhi·ªÖu n√†y c≈©ng b·ªã coi l√† "bi√™n", t·∫°o ra bi√™n gi·∫£.  
- Blur kernel gi√∫p **l√†m tr∆°n (smooth)** c·ª•c b·ªô, gi·∫£m nhi·ªÖu, gi·ªØ l·∫°i c·∫•u tr√∫c l·ªõn ‚Üí bi√™n th·∫≠t ƒë∆∞·ª£c nh·∫•n m·∫°nh h∆°n.

---

### Pipeline c∆° b·∫£n

$$
I_{edge} = (I * K_{blur}) * K_{edge}
$$

Trong ƒë√≥:
- $I$: ·∫£nh g·ªëc  
- $K_{blur}$: kernel l√†m m·ªù (v√≠ d·ª• trung b√¨nh 3x3)  
- $K_{edge}$: kernel bi√™n (Sobel, Laplacian, ho·∫∑c custom)  

---

### V√≠ d·ª• minh h·ªça

1. **·∫¢nh g·ªëc**: c√≥ nhi·ªÅu chi ti·∫øt v√† nhi·ªÖu.  
2. **Blur (3x3 mean filter)**: gi·∫£m nhi·ªÖu, l√†m m∆∞·ª£t ·∫£nh.  
3. **Edge Filter (v√≠ d·ª• Laplacian)**: ph√°t hi·ªán bi√™n r√µ r√†ng, √≠t b·ªã r·ªëi b·ªüi nhi·ªÖu.

K·∫øt qu·∫£:  
- N·∫øu b·ªè b∆∞·ªõc Blur ‚Üí bi√™n xu·∫•t hi·ªán c·∫£ ·ªü v√πng nhi·ªÖu (bi√™n gi·∫£).  
- N·∫øu c√≥ Blur ‚Üí bi√™n ch·ªß y·∫øu ·ªü v√πng thay ƒë·ªïi th·∫≠t s·ª± (v·∫≠t th·ªÉ, contour).

---

### Minh h·ªça to√°n h·ªçc

## 4. Blur ƒë·ªÉ gi·∫£m nhi·ªÖu tr∆∞·ªõc khi Edge Detection  

### 1. Nhi·ªÖu ·∫£nh l√† g√¨?  
Trong ·∫£nh th·∫≠t th∆∞·ªùng t·ªìn t·∫°i **pixel nhi·ªÖu**:  
- ƒêi·ªÉm s√°ng b·∫•t th∆∞·ªùng  
- ƒêi·ªÉm t·ªëi b·∫•t th∆∞·ªùng  
- Dao ƒë·ªông ng·∫´u nhi√™n v·ªÅ c∆∞·ªùng ƒë·ªô  

V√≠ d·ª•: trong ·∫£nh x√°m 8-bit (0‚Äì255), v√πng xung quanh c√≥ gi√° tr·ªã ~100‚Äì120, nh∆∞ng xu·∫•t hi·ªán m·ªôt pixel = 250 ‚Üí ƒë√≥ l√† **nhi·ªÖu**.

---

### 2. Blur ho·∫°t ƒë·ªông nh∆∞ th·∫ø n√†o?  
Kernel l√†m m·ªù (v√≠ d·ª• **mean filter 3x3**) l·∫•y gi√° tr·ªã trung b√¨nh c·ªßa c√°c ƒëi·ªÉm l√¢n c·∫≠n:  

$$
I'(x,y) = \frac{1}{N} \sum_{i=-k}^{k} \sum_{j=-k}^{k} I(x+i, y+j)
$$  

Trong ƒë√≥ $N$ l√† s·ªë ph·∫ßn t·ª≠ trong kernel (v√≠ d·ª• 9 cho kernel 3x3).  

‚û° N·∫øu c√≥ m·ªôt pixel nhi·ªÖu (r·∫•t kh√°c bi·ªát so v·ªõi h√†ng x√≥m), gi√° tr·ªã ƒë√≥ s·∫Ω b·ªã **pha lo√£ng** trong ph√©p trung b√¨nh ‚Üí gi·∫£m t√°c ƒë·ªông c·ªßa nhi·ªÖu.  

---

### 3. V√≠ d·ª• minh h·ªça  

·∫¢nh g·ªëc 3x3 c√≥ m·ªôt pixel nhi·ªÖu:  

$$
I = \begin{bmatrix}
100 & 102 & 101 \\
99 & 250 & 98 \\
100 & 101 & 99
\end{bmatrix}
$$  

- Pixel trung t√¢m = 250, r√µ r√†ng b·∫•t th∆∞·ªùng (c√°c gi√° tr·ªã kh√°c ch·ªâ quanh ~100).  
- N·∫øu kh√¥ng l·ªçc, ƒëi·ªÉm n√†y s·∫Ω hi·ªán l√™n nh∆∞ m·ªôt ch·∫•m tr·∫Øng ch√≥i.  

√Åp d·ª•ng **mean blur 3x3**:  

$$
I'(1,1) = \frac{100+102+101+99+250+98+100+101+99}{9} = \frac{1050}{9} \approx 117
$$  

üëâ Gi√° tr·ªã 250 ƒë√£ b·ªã ‚Äúpha lo√£ng‚Äù, gi·∫£m v·ªÅ ~117, g·∫ßn h∆°n v·ªõi b·ªëi c·∫£nh (~100).  

---

### 4. √ù nghƒ©a trong edge detection  
- **Kh√¥ng l√†m m·ªù tr∆∞·ªõc**: nhi·ªÖu t·∫°o ra c√°c bi√™n gi·∫£ khi d√πng Sobel, Laplacian ‚Üí ·∫£nh b·ªã r·ªëi, nhi·ªÅu c·∫°nh kh√¥ng th·∫≠t.  
- **C√≥ l√†m m·ªù tr∆∞·ªõc**: nhi·ªÖu gi·∫£m, bi√™n th·∫≠t (contour) gi·ªØ l·∫°i r√µ h∆°n ‚Üí gi√∫p Edge Detection ·ªïn ƒë·ªãnh v√† ch√≠nh x√°c h∆°n.  


---

## 5. T·ªïng k·∫øt

- Pipeline chu·∫©n trong x·ª≠ l√Ω ·∫£nh c·ªï ƒëi·ªÉn:  
  **·∫¢nh g·ªëc ‚Üí Blur (gi·∫£m nhi·ªÖu) ‚Üí Edge Filter (Sobel/Laplacian/custom)**  
- Blur ƒë√≥ng vai tr√≤ nh∆∞ "b·ªô l·ªçc tr∆∞·ªõc" ƒë·ªÉ bi√™n ph√°t hi·ªán ra **√≠t nhi·ªÖu, ch√≠nh x√°c h∆°n**.

---
---


## 5. Ki·∫øn tr√∫c CNN c∆° b·∫£n: Conv ‚Üí Pooling ‚Üí Flatten ‚Üí Fully Connected ‚Üí Softmax

### 1. Convolution (Conv)
- ƒê√£ tr√¨nh b√†y chi ti·∫øt ·ªü ph·∫ßn tr∆∞·ªõc (cross-correlation).
- **Gi·∫£ s·ª≠** sau Conv (same padding) thu ƒë∆∞·ª£c feature map 5√ó5 (v√≠ d·ª• v·ªõi Horizontal Filter):

$$
S = \begin{bmatrix}
-5 & -6 & -3 & 0 & 1 \\
2 & 6 & 12 & 18 & 14 \\
16 & 21 & 15 & 9 & 4 \\
-4 & -9 & -15 & -21 & -16 \\
-5 & -3 & 6 & 15 & 13
\end{bmatrix}
$$

---

### 2. Pooling (v√≠ d·ª•: Max Pooling, c·ª≠a s·ªï 2x2, stride = 2)
- M·ª•c ti√™u: gi·∫£m k√≠ch th∆∞·ªõc kh√¥ng gian, gi·ªØ ƒë·∫∑c tr∆∞ng m·∫°nh nh·∫•t t·ª´ng v√πng.

C√°c v√πng 2x2 (valid) v√† gi√° tr·ªã l·ªõn nh·∫•t:
```lua
- √î (1): h√†ng 1‚Äì2, c·ªôt 1‚Äì2  

[[-5, -6],
[ 2, 6]] ‚Üí max = 6

- √î (2): h√†ng 1‚Äì2, c·ªôt 3‚Äì4  
[[-3, 0],
[12, 18]] ‚Üí max = 18

- √î (3): h√†ng 3‚Äì4, c·ªôt 1‚Äì2  
[[16, 21],
[-4, -9]] ‚Üí max = 21

- √î (4): h√†ng 3‚Äì4, c·ªôt 3‚Äì4  
[[15, 9],
[-15, -21]] ‚Üí max = 15

K·∫øt qu·∫£ Max Pooling (ma tr·∫≠n 2x2):

P = [[ 6, 18 ],
[21, 15 ]]
```

> Ghi ch√∫: V·ªõi stride = 2 v√† kernel 2x2 tr√™n ƒë·∫ßu v√†o 5x5, ph·∫ßn r√¨a cu·ªëi kh√¥ng ƒë·ªß c·ª≠a s·ªï n√™n b·ªã b·ªè qua

---

### 3. Flatten
- Chuy·ªÉn $P \in \mathbb{R}^{2 \times 2}$ th√†nh vector h√†ng $1 \times 4$ (theo th·ª© t·ª± h√†ng‚Äìc·ªôt):

$$
x = \mathrm{Flatten}(P) = [\,6,\;18,\;21,\;15\,]
$$

---

### 4. Fully Connected (Dense Layer)
- Gi·∫£ s·ª≠ ta c√≥ 3 l·ªõp ƒë·∫ßu ra (3 classes).  
- Tr·ªçng s·ªë $W \in \mathbb{R}^{3 \times 4}$, bias $b \in \mathbb{R}^{3}$:

$$
W = \begin{bmatrix}
0.10 & 0.05 & 0.02 & 0.01 \\
0.05 & 0.02 & 0.01 & 0.04 \\
0.01 & 0.00 & 0.01 & 0.00
\end{bmatrix},\quad
b = \begin{bmatrix}
0.93 \\
-0.47 \\
-0.27
\end{bmatrix}
$$

T√≠nh **logits** $z = W x^\top + b$:

$$
\begin{aligned}
z_1 &= 0.10\cdot 6 + 0.05\cdot 18 + 0.02\cdot 21 + 0.01\cdot 15 + 0.93 \\
    &= 0.60 + 0.90 + 0.42 + 0.15 + 0.93 = 3.00 \\[4pt]

z_2 &= 0.05\cdot 6 + 0.02\cdot 18 + 0.01\cdot 21 + 0.04\cdot 15 - 0.47 \\
    &= 0.30 + 0.36 + 0.21 + 0.60 - 0.47 = 1.00 \\[4pt]
    
z_3 &= 0.01\cdot 6 + 0.00\cdot 18 + 0.01\cdot 21 + 0.00\cdot 15 - 0.27 \\
    &= 0.06 + 0 + 0.21 + 0 - 0.27 = 0.00
\end{aligned}
$$

V·∫≠y:

$$
z = [\,3,\;1,\;0\,]
$$

---

### 5. Softmax (Output Layer)
- Chuy·ªÉn logits th√†nh x√°c su·∫•t:

$$
\mathrm{Softmax}(z_i) = \frac{e^{z_i}}{\sum_{j=1}^{C} e^{z_j}}, \quad C=3
$$

T√≠nh tr·ª±c ti·∫øp:

$$
e^{3}=20.0855,\; e^{1}=2.7183,\; e^{0}=1.0000 \\
\Rightarrow \sum = 23.8038
$$

X√°c su·∫•t:

$$
p = \left[\frac{20.0855}{23.8038},\; \frac{2.7183}{23.8038},\; \frac{1.0000}{23.8038}\right]
\approx [\,0.8438,\;0.1142,\;0.0420\,]
$$

> G·ª£i √Ω t√≠nh ·ªïn ƒë·ªãnh s·ªë: tr·ª´ $\max(z)=3$ tr∆∞·ªõc khi m≈© ho√°  
> $z'=[0,-2,-3] \Rightarrow e^{z'}=[1,0.1353,0.0498],\; \sum=1.1851$  
> $p=[1/1.1851,\;0.1353/1.1851,\;0.0498/1.1851] \approx [0.8438,0.1142,0.0420]$.

---

‚úÖ **Chu·ªói x·ª≠ l√Ω ƒë·∫ßy ƒë·ªß (v√≠ d·ª• s·ªë h·ªçc):**  
**Conv (ra $5\times5$ S)** ‚Üí **MaxPool $2\times2$ (ra $2\times2$ P)** ‚Üí **Flatten ($x=[6,18,21,15]$)** ‚Üí **FC ($z=[3,1,0]$)** ‚Üí **Softmax ($p\approx[0.844,0.114,0.042]$)**

