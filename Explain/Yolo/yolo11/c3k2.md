# ğŸ“Œ C3 vÃ  C3K2 trong Backbone YOLOv11

---

## 1ï¸âƒ£ C3 lÃ  gÃ¬?  
**C3 (Cross Stage Partial with 3 convolutions)** â€“ block chuáº©n trong YOLOv5â€“YOLOv8.  
Dá»±a trÃªn Ã½ tÆ°á»Ÿng **CSPNet**, gá»“m:  

- **NhÃ¡nh 1 (skip connection nháº¹):** cho phÃ©p gradient Ä‘i tháº³ng, khÃ´ng bá»‹ ngháº½n.  
- **NhÃ¡nh 2 (xá»­ lÃ½ sÃ¢u):** gá»“m nhiá»u bottleneck (1Ã—1 â†’ 3Ã—3 â†’ 1Ã—1).  
- **GhÃ©p (fusion):** trá»™n hai nhÃ¡nh láº¡i â†’ vá»«a giá»¯ Ä‘áº·c trÆ°ng thÃ´, vá»«a thÃªm Ä‘áº·c trÆ°ng phá»©c táº¡p.  

ğŸ‘‰ Æ¯u Ä‘iá»ƒm: cÃ¢n báº±ng giá»¯a **Ä‘á»™ chÃ­nh xÃ¡c** vÃ  **tá»‘c Ä‘á»™**.

---

## 2ï¸âƒ£ Váº­y â€œK2â€ lÃ  gÃ¬?  
**K2 = Kernel Interaction Level 2 (Kernel 2-stage).**  
Ã tÆ°á»Ÿng: thay Ä‘á»•i cÃ¡ch dÃ¹ng kernel trong C3 Ä‘á»ƒ **má»Ÿ rá»™ng receptive field** mÃ  khÃ´ng tÄƒng nhiá»u FLOPs.  

CÃ¡ch triá»ƒn khai K2:  
- Stack nhiá»u conv 3Ã—3 liÃªn tiáº¿p (má»Ÿ rá»™ng receptive field).  
- DÃ¹ng **dilated conv** (giÃ£n khoáº£ng láº¥y máº«u, nhÃ¬n xa hÆ¡n).  
- Multi-kernel fusion (káº¿t há»£p 3Ã—3, 5Ã—5, 7Ã—7).  

ğŸ‘‰ NÃ³i nÃ´m na: **K2 = cháº¿ kernel Ä‘á»ƒ mÃ´ hÃ¬nh nhÃ¬n rá»™ng hÆ¡n trong cÃ¹ng má»™t bÆ°á»›c** â†’ khÃ´ng cáº§n tÄƒng thÃªm nhiá»u block C3.

---

## 3ï¸âƒ£ C3K2 trong Backbone YOLOv11  

ğŸ¯ **Má»¥c tiÃªu:**  
- Má»Ÿ rá»™ng receptive field sá»›m â†’ phÃ¡t hiá»‡n váº­t thá»ƒ nhá» tá»‘t hÆ¡n.  
- TÄƒng hiá»‡u quáº£ trÃ­ch xuáº¥t Ä‘áº·c trÆ°ng â†’ Ã­t tÃ­nh toÃ¡n dÆ° thá»«a, phÃ¹ há»£p real-time.  
- Giá»¯ gradient flow mÆ°á»£t nhá» nhÃ¡nh skip + CSP.  
- TÃ¡i sá»­ dá»¥ng Ä‘áº·c trÆ°ng qua nhiá»u bottleneck nhÆ°ng váº«n kiá»ƒm soÃ¡t FLOPs/params.  

ğŸ‘‰ HÃ¬nh dung: **C3K2 giá»‘ng nhÆ° thay â€œá»‘ng kÃ­nh gÃ³c rá»™ngâ€ cho C3.**  
CÃ¹ng má»™t bÆ°á»›c, mÃ´ hÃ¬nh nhÃ¬n xa hÆ¡n, gom ngá»¯ cáº£nh nhiá»u hÆ¡n mÃ  khÃ´ng Ä‘á»™i chi phÃ­ quÃ¡ cao.

---

## 4ï¸âƒ£ Cáº¥u trÃºc khÃ¡i niá»‡m (Ä‘Æ¡n giáº£n hoÃ¡)  

- **NhÃ¡nh 1 (skip nháº¹):** truyá»n Ä‘áº·c trÆ°ng thÃ´, giá»¯ gradient á»•n.  
- **NhÃ¡nh 2 (xá»­ lÃ½ sÃ¢u):** nhiá»u conv/bottleneck vá»›i K2 kernel (má»Ÿ rá»™ng receptive field).  
- **GhÃ©p Ä‘áº·c trÆ°ng:** trá»™n NhÃ¡nh 1 vÃ  NhÃ¡nh 2 Ä‘á»ƒ cÃ³ Ä‘áº·c trÆ°ng phong phÃº hÆ¡n.  

---

## 5ï¸âƒ£ So sÃ¡nh trá»±c quan: C3 vs C3K2  

| Äáº·c Ä‘iá»ƒm              | C3 (chuáº©n)       | C3K2 (YOLOv11)                 |
|------------------------|------------------|--------------------------------|
| **Kernel**            | 1Ã—1, 3Ã—3         | K2-modified (stacked, dilated, multi-kernel) |
| **Receptive field**   | Nhá» hÆ¡n          | Rá»™ng hÆ¡n (nhÃ¬n xa hÆ¡n)         |
| **Gradient flow**     | CÃ³ skip          | CÃ³ skip (giá»¯ á»•n)               |
| **Chi phÃ­ tÃ­nh toÃ¡n** | Tháº¥p             | Gáº§n nhÆ° tÆ°Æ¡ng Ä‘Æ°Æ¡ng, hiá»‡u quáº£ hÆ¡n |
| **PhÃ¡t hiá»‡n váº­t thá»ƒ** | Vá»«a              | Tá»‘t hÆ¡n, Ä‘áº·c biá»‡t vá»›i váº­t thá»ƒ nhá» |

ğŸ‘‰ **TÃ³m láº¡i:**  
- **C3** = block backbone chuáº©n YOLO (tá»‘i Æ°u tá»‘c Ä‘á»™).  
- **C3K2** = báº£n nÃ¢ng cáº¥p trong YOLOv11, chá»‰nh kernel Ä‘á»ƒ má»Ÿ rá»™ng receptive field sá»›m, giÃºp backbone máº¡nh hÆ¡n ngay tá»« Ä‘áº§u.

---
---

![c3k2](../../../imgs/conv_c3k2.jpg)

# C3K2 qua luá»“ng xá»­ lÃ½ CNN (minh há»a)

## Má»¥c tiÃªu: cho báº¡n tháº¥y C3K2 hoáº¡t Ä‘á»™ng tháº¿ nÃ o bÃªn trong backbone, khÃ¡c gÃ¬ so vá»›i hai lá»›p Conv downsample trÆ°á»›c Ä‘Ã³.

1) Luá»“ng xá»­ lÃ½ tá»•ng quan (hÃ¬nh dáº¡ng tensor)

```r
Input:  640Ã—640Ã—3
  â†“ Conv (stride=2)       â†’ 320Ã—320Ã—(min(64, mc) Ã— w)
  â†“ Conv (stride=2)       â†’ 160Ã—160Ã—(min(128, mc) Ã— w)  = 160Ã—160Ã—C
  â†“ C3K2 block (á»Ÿ cÃ¹ng HÃ—W) â†’ 160Ã—160Ã—C  (tÄƒng cháº¥t lÆ°á»£ng Ä‘áº·c trÆ°ng, giá»¯ kÃ­ch thÆ°á»›c)

```

- Hai lá»›p Conv Ä‘áº§u: chá»§ yáº¿u giáº£m kÃ­ch thÆ°á»›c (downsample) vÃ  Ä‘iá»u chá»‰nh sá»‘ kÃªnh.

- C3K2: khÃ´ng pháº£i â€œgá»™p hai Conv kiaâ€, mÃ  lÃ  má»™t block trÃ­ch xuáº¥t Ä‘áº·c trÆ°ng máº¡nh hÆ¡n C3 (má»Ÿ rá»™ng receptive field) á»Ÿ cÃ¹ng Ä‘á»™ phÃ¢n giáº£i.

2) BÃªn trong C3K2 (sÆ¡ Ä‘á»“ khá»‘i)

```less
Input (160Ã—160Ã—C)
 â”œâ”€ NhÃ¡nh 1 (skip): 1Ã—1 conv â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
 â”‚                                           â”‚
 â””â”€ NhÃ¡nh 2 (deep): 1Ã—1 conv â†’ [3Ã—3] â†’ [3Ã—3] â†’ 1Ã—1 conv
                                               â”‚
 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ Concatenate (NhÃ¡nh 1 + NhÃ¡nh 2) â”€â”€â†’ 1Ã—1 conv (fusion) â”€â†’ Output (160Ã—160Ã—C)

```

- NhÃ¡nh skip (1Ã—1 conv): giá»¯ â€œphiÃªn báº£n nháº¹â€ cá»§a Ä‘áº·c trÆ°ng gá»‘c â†’ giÃºp gradient Ä‘i mÆ°á»£t, trÃ¡nh máº¥t mÃ¡t thÃ´ng tin.

- NhÃ¡nh deep: 1Ã—1 Ä‘á»ƒ giáº£m kÃªnh â†’ K2 = 2 conv 3Ã—3 liÃªn tiáº¿p (má»Ÿ receptive field tá»« 3Ã—3 â†’ 5Ã—5) â†’ 1Ã—1 Ä‘á»ƒ trá»™n/tÄƒng kÃªnh.

- Concat + 1Ã—1 fusion: trá»™n hai nhÃ¡nh thÃ nh Ä‘áº·c trÆ°ng cuá»‘i cÃ³ ngá»¯ cáº£nh rá»™ng hÆ¡n, nhiá»…u tháº¥p hÆ¡n.

- Gá»£i hÃ¬nh: K2 giá»‘ng â€œgáº¯n á»‘ng kÃ­nh gÃ³c rá»™ngâ€ cho nhÃ¡nh deep cá»§a C3.

3) Minh há»a báº±ng ma tráº­n 2D (receptive field)

#### 3.1) Input toy 5Ã—5 (Ä‘Ã¡nh sá»‘ Ä‘á»ƒ theo dÃµi)

```lua
 1   2   3   4   5
 6   7   8   9  10
11  12  13  14  15
16  17  18  19  20
21  22  23  24  25
```

#### 3.2) Náº¿u chá»‰ 1 conv 3Ã—3 (kiá»ƒu C3 chuáº©n á»Ÿ nhÃ¡nh deep)

- Vá»›i tÃ¢m (Ã´ 13), vÃ¹ng â€œnhÃ¬n tháº¥yâ€ lÃ  3Ã—3:

```lua
 7   8   9
12  13  14
17  18  19
```

> â†’ Receptive field = 3Ã—3 (thÃ´ng tin khÃ¡ cá»¥c bá»™).

#### 3.3) Vá»›i K2 = 2 conv 3Ã—3 liÃªn tiáº¿p (C3K2)

- Láº§n conv thá»© nháº¥t â€œgomâ€ 3Ã—3 quanh 13.

- Láº§n conv thá»© hai tiáº¿p tá»¥c â€œgomâ€ 3Ã—3 quanh káº¿t quáº£ Ä‘Ã³ â†’ hiá»‡u á»©ng lan rá»™ng.

- Receptive field hiá»‡u dá»¥ng trá»Ÿ thÃ nh 5Ã—5:

```lua
 1   2   3   4   5
 6   7   8   9  10
11  12  13  14  15
16  17  18  19  20
21  22  23  24  25

```
> â†’ Má»—i Ä‘iá»ƒm Ä‘áº§u ra á»Ÿ nhÃ¡nh deep nhÃ¬n rá»™ng hÆ¡n, giá»¯ Ä‘Æ°á»£c ngá»¯ cáº£nh tá»‘t hÆ¡n (váº­t thá»ƒ nhá», chi tiáº¿t xa).

4) VÃ­ dá»¥ luá»“ng nhá» gá»n (so vá»›i hai Conv downsample)

#### 4.1) Hai Conv trÆ°á»›c C3K2 (downsample)

```lua
Input 640Ã—640Ã—3
  â†“ Conv s=2 â†’ 320Ã—320Ã—(min(64, mc) Ã— w)
  â†“ Conv s=2 â†’ 160Ã—160Ã—(min(128, mc) Ã— w) = 160Ã—160Ã—C

```

- Chá»©c nÄƒng chÃ­nh: giáº£m HÃ—W, â€œdá»“nâ€ thÃ´ng tin vÃ o kÃªnh.

#### 4.2) C3K2 sau downsample (trÃ­ch xuáº¥t Ä‘áº·c trÆ°ng á»Ÿ cÃ¹ng HÃ—W)

```lua
Input 160Ã—160Ã—C
  â†“ C3K2 (skip + deep K2 + fusion)
Output 160Ã—160Ã—C  (Ä‘áº·c trÆ°ng giÃ u ngá»¯ cáº£nh hÆ¡n)

```

- Chá»©c nÄƒng chÃ­nh: nÃ¢ng cháº¥t lÆ°á»£ng Ä‘áº·c trÆ°ng, má»Ÿ rá»™ng receptive field (3Ã—3 â†’ 5Ã—5) mÃ  khÃ´ng Ä‘á»•i HÃ—W.

---

5) TÃ³m táº¯t nhanh

- Conv (stride=2): downsample, Ä‘á»•i sá»‘ kÃªnh â†’ chuáº©n bá»‹ cho trÃ­ch xuáº¥t sÃ¢u.

- C3 (chuáº©n): skip + bottleneck (thÆ°á»ng 1 conv 3Ã—3) â†’ giá»¯ thÃ´ + táº¡o Ä‘áº·c trÆ°ng má»›i.

- C3K2: váº«n skip + bottleneck nhÆ°ng bottleneck dÃ¹ng 2Ã—3Ã—3 liÃªn tiáº¿p (K2) â†’ receptive field rá»™ng hÆ¡n, Ä‘áº·c trÆ°ng máº¡nh hÆ¡n cho cÃ¡c táº§ng sau (neck/head).

> Äiá»ƒm máº¥u chá»‘t: C3K2 khÃ´ng pháº£i lÃ  â€œ2 Conv downsample gá»™p láº¡iâ€. NÃ³ lÃ  má»™t block C3 nÃ¢ng cáº¥p vá»›i K2 á»Ÿ nhÃ¡nh deep, Ä‘áº·t sau hai Conv downsample Ä‘á»ƒ tá»‘i Ä‘a hÃ³a hiá»‡u quáº£ trÃ­ch xuáº¥t táº¡i cÃ¹ng Ä‘á»™ phÃ¢n giáº£i.